#Область ОбработкаПроведения

Процедура ОбработкаПроведения(Отказ, Режим)
	
	// 1. Инициализация наборов записей
	Движения.ВКМ_ОсновныеНачисления.Записывать = Истина;
	Движения.ВКМ_ОсновныеНачисления.Очистить();
	
	Движения.ВКМ_ДополнительныеНачисления.Записывать = Истина;
	Движения.ВКМ_ДополнительныеНачисления.Очистить();
	
	Движения.ВКМ_Удержания.Записывать = Истина;
	Движения.ВКМ_Удержания.Очистить();
	
	Движения.ВКМ_ВзаиморасчетыССотрудниками.Записывать = Истина;
	Движения.ВКМ_ВзаиморасчетыССотрудниками.Очистить();
	
	// 2. Подготовка движений
	СформироватьДвиженияПоОкладам(Отказ);
	СформироватьДвиженияПоДругимНачислениям(); // Отпуска и другие основные
	СформироватьСторноЗаписи();
	
	Если Отказ Тогда Возврат; КонецЕсли;
	
	// Записываем "пустышки" для построения графиков вытеснения
	Движения.ВКМ_ОсновныеНачисления.Записать( , Истина);
	
	// 3. РАСЧЕТЫ (Строгая последовательность)
	
	// 3.1 Рассчитываем ОТПУСК (он вытесняет оклад)
	РассчитатьОтпускные();
	Движения.ВКМ_ОсновныеНачисления.Записать( , Истина); // Записываем результат и факт вытеснения
	
	// 3.2 Рассчитываем ОКЛАД (с учетом вытеснения отпуском)
	РассчитатьОклад();
	Движения.ВКМ_ОсновныеНачисления.Записать( , Истина); 
	
	// 3.3 Рассчитываем ПРОЦЕНТ (Начисление в доп. регистр)
	РассчитатьПремии(); // Здесь внутри есть своя запись ВКМ_ДополнительныеНачисления
	
	// 3.4 Рассчитываем НДФЛ (база со всех начислений текущего документа)
	РассчитатьНДФЛ();
	
	// 3.5 Заполняем Взаиморасчеты
	ЗаполнитьВзаиморасчеты();
	
КонецПроцедуры

#КонецОбласти

#Область СлужебныеПроцедуры

// Процедура разбивает месяц на периоды действия окладов (если менялся оклад внутри месяца)
Процедура СформироватьДвиженияПоОкладам(Отказ)
	
	МинимальнаяДатаНачала = Неопределено;
	МаксимальнаяДатаОкончания = Неопределено;
	
	ЕстьОклад = Ложь;
	Для Каждого Строка Из Начисления Цикл
		Если Строка.ВидРасчета = ПланыВидовРасчета.ВКМ_ОсновныеНачисления.Оклад Тогда
			ЕстьОклад = Истина;
			Если МинимальнаяДатаНачала = Неопределено Или Строка.ДатаНачала < МинимальнаяДатаНачала Тогда
				МинимальнаяДатаНачала = Строка.ДатаНачала;
			КонецЕсли;
			Если МаксимальнаяДатаОкончания = Неопределено Или Строка.ДатаОкончания > МаксимальнаяДатаОкончания Тогда
				МаксимальнаяДатаОкончания = Строка.ДатаОкончания;
			КонецЕсли;
		КонецЕсли;
	КонецЦикла;
	
	Если Не ЕстьОклад Тогда Возврат; КонецЕсли;

	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	ТЧ.Сотрудник КАК Сотрудник,
	|	ТЧ.ВидРасчета КАК ВидРасчета,
	|	ТЧ.ДатаНачала КАК ДатаНачала,
	|	ТЧ.ДатаОкончания КАК ДатаОкончания,
	|	ТЧ.ГрафикРаботы КАК ГрафикРаботы
	|ПОМЕСТИТЬ ВТ_ТЧ
	|ИЗ
	|	Документ.ВКМ_НачисленияЗарплаты.Начисления КАК ТЧ
	|ГДЕ
	|	ТЧ.Ссылка = &Ссылка
	|	И ТЧ.ВидРасчета = &ВидРасчетаОклад
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	СрезПоследних.ВКМ_Сотрудник КАК Сотрудник,
	|	СрезПоследних.Период КАК Период,
	|	СрезПоследних.ВКМ_Оклад КАК Оклад
	|ПОМЕСТИТЬ ВТ_История
	|ИЗ
	|	РегистрСведений.ВКМ_УсловияОплатыСотрудников.СрезПоследних(&МинимальнаяДатаНачала, ВКМ_Сотрудник В
	|		(ВЫБРАТЬ
	|			Т.Сотрудник
	|		ИЗ
	|			ВТ_ТЧ КАК Т)) КАК СрезПоследних
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	История.ВКМ_Сотрудник,
	|	История.Период,
	|	История.ВКМ_Оклад
	|ИЗ
	|	РегистрСведений.ВКМ_УсловияОплатыСотрудников КАК История
	|ГДЕ
	|	История.Период > &МинимальнаяДатаНачала
	|	И История.Период <= &МаксимальнаяДатаОкончания
	|	И История.ВКМ_Сотрудник В
	|		(ВЫБРАТЬ
	|			Т.Сотрудник
	|		ИЗ
	|			ВТ_ТЧ КАК Т)
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	Вложенный.Сотрудник КАК Сотрудник,
	|	Вложенный.ДатаНачала КАК ДатаНачала,
	|	ЕСТЬNULL(ДОБАВИТЬКДАТЕ(Вложенный.СледующаяДата, СЕКУНДА, -1), ДАТАВРЕМЯ(3999, 12, 31)) КАК ДатаОкончания,
	|	Вложенный.Оклад КАК Оклад
	|ПОМЕСТИТЬ ВТ_Интервалы
	|ИЗ
	|	(ВЫБРАТЬ
	|		История.Сотрудник КАК Сотрудник,
	|		История.Период КАК ДатаНачала,
	|		История.Оклад КАК Оклад,
	|		МИНИМУМ(ИсторияСлед.Период) КАК СледующаяДата
	|	ИЗ
	|		ВТ_История КАК История
	|			ЛЕВОЕ СОЕДИНЕНИЕ ВТ_История КАК ИсторияСлед
	|			ПО История.Сотрудник = ИсторияСлед.Сотрудник
	|			И История.Период < ИсторияСлед.Период
	|	СГРУППИРОВАТЬ ПО
	|		История.Сотрудник,
	|		История.Период,
	|		История.Оклад) КАК Вложенный
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ВТ_ТЧ.Сотрудник КАК Сотрудник,
	|	ВТ_ТЧ.ВидРасчета КАК ВидРасчета,
	|	ВТ_ТЧ.ГрафикРаботы КАК ГрафикРаботы,
	|	ВЫБОР
	|		КОГДА ВТ_ТЧ.ДатаНачала > ВТ_Интервалы.ДатаНачала
	|			ТОГДА ВТ_ТЧ.ДатаНачала
	|		ИНАЧЕ ВТ_Интервалы.ДатаНачала
	|	КОНЕЦ КАК ПериодДействияНачало,
	|	ВЫБОР
	|		КОГДА ВТ_ТЧ.ДатаОкончания < ВТ_Интервалы.ДатаОкончания
	|			ТОГДА ВТ_ТЧ.ДатаОкончания
	|		ИНАЧЕ ВТ_Интервалы.ДатаОкончания
	|	КОНЕЦ КАК ПериодДействияКонец,
	|	ВТ_Интервалы.Оклад КАК ВКМ_Показатель
	|ИЗ
	|	ВТ_ТЧ КАК ВТ_ТЧ
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТ_Интервалы КАК ВТ_Интервалы
	|		ПО ВТ_ТЧ.Сотрудник = ВТ_Интервалы.Сотрудник
	|		И ВТ_ТЧ.ДатаНачала <= ВТ_Интервалы.ДатаОкончания
	|		И ВТ_ТЧ.ДатаОкончания >= ВТ_Интервалы.ДатаНачала";
	
	Запрос.УстановитьПараметр("Ссылка", Ссылка);
	Запрос.УстановитьПараметр("ВидРасчетаОклад", ПланыВидовРасчета.ВКМ_ОсновныеНачисления.Оклад);
	Запрос.УстановитьПараметр("МинимальнаяДатаНачала", МинимальнаяДатаНачала);
	Запрос.УстановитьПараметр("МаксимальнаяДатаОкончания", МаксимальнаяДатаОкончания);
	
	Выборка = Запрос.Выполнить().Выбрать();
	
	Пока Выборка.Следующий() Цикл
		Движение = Движения.ВКМ_ОсновныеНачисления.Добавить();
		ЗаполнитьЗначенияСвойств(Движение, Выборка);
		
		Движение.ПериодРегистрации = Дата;
		
		If Движение.ВКМ_Показатель = 0 Then
			// Можно добавить логирование
		EndIf;
	КонецЦикла;

КонецПроцедуры

Процедура СформироватьДвиженияПоДругимНачислениям()
	
	Для Каждого Строка Из Начисления Цикл
		Если Строка.ВидРасчета = ПланыВидовРасчета.ВКМ_ОсновныеНачисления.Оклад Тогда
			Продолжить; 
		КонецЕсли;
		
		Движение = Движения.ВКМ_ОсновныеНачисления.Добавить();
		Движение.ПериодРегистрации    = Дата;
		Движение.ПериодДействияНачало = Строка.ДатаНачала;
		Движение.ПериодДействияКонец  = Строка.ДатаОкончания;
		Движение.ВКМ_Сотрудник            = Строка.Сотрудник;
		Движение.ВидРасчета           = Строка.ВидРасчета;
		Движение.ГрафикРаботы         = Строка.ГрафикРаботы;
		
	КонецЦикла;
	
КонецПроцедуры

Процедура РассчитатьОклад()
	
	Запрос = Новый Запрос;
	// Получаем факт и норму через виртуальную таблицу ДанныеГрафика
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	ДанныеГрафика.НомерСтроки КАК НомерСтроки,
	|	ЕСТЬNULL(ДанныеГрафика.ЗначениеФактическийПериодДействия, 0) КАК Отработано,
	|	ЕСТЬNULL(ДанныеГрафика.ЗначениеПериодДействия, 0) КАК Норма
	|ИЗ
	|	РегистрРасчета.ВКМ_ОсновныеНачисления.ДанныеГрафика(Регистратор = &Ссылка
	|	И ВидРасчета = &ВидРасчетаОклад) КАК ДанныеГрафика";
	
	Запрос.УстановитьПараметр("Ссылка", Ссылка);
	Запрос.УстановитьПараметр("ВидРасчетаОклад", ПланыВидовРасчета.ВКМ_ОсновныеНачисления.Оклад);
	
	Выборка = Запрос.Выполнить().Выбрать();
	
	Пока Выборка.Следующий() Цикл
		
		Движение = Движения.ВКМ_ОсновныеНачисления[Выборка.НомерСтроки - 1];
		
		Ставка = Движение.ВКМ_Показатель;
		
		Если Выборка.Норма = 0 Тогда
			Движение.ВКМ_Результат = 0;
		Иначе
			Движение.ВКМ_Результат = Ставка * Выборка.Отработано / Выборка.Норма;
		КонецЕсли;
		
		// ВАЖНО: Записываем отработанные дни для расчета среднего заработка (отпускных) в будущем
		// Предполагаем, что График в днях. Если в часах, делим на 8.
		Движение.ВКМ_ОтработаноДней = Выборка.Отработано; 
		
		Если Движение.Сторно Тогда
			Движение.ВКМ_Результат = -Движение.ВКМ_Результат;
			Движение.ВКМ_ОтработаноДней = -Движение.ВКМ_ОтработаноДней;
		КонецЕсли;
		
	КонецЦикла;
	
КонецПроцедуры

Процедура СформироватьСторноЗаписи()
	
	СторноЗаписи = Движения.ВКМ_ОсновныеНачисления.ПолучитьДополнение();
	
	Для Каждого СтрокаСторно Из СторноЗаписи Цикл
		Движение = Движения.ВКМ_ОсновныеНачисления.Добавить();
		ЗаполнитьЗначенияСвойств(Движение, СтрокаСторно);
		
		Движение.ПериодРегистрации = Дата;
		Движение.ПериодДействияНачало = СтрокаСторно.ПериодДействияНачалоСторно;
		Движение.ПериодДействияКонец = СтрокаСторно.ПериодДействияКонецСторно;
		Движение.Сторно = Истина;
		
		Движение.ВКМ_Результат = -СтрокаСторно.ВКМ_Результат;
		Движение.ВКМ_ОтработаноДней = -СтрокаСторно.ВКМ_ОтработаноДней;
	КонецЦикла;
	
КонецПроцедуры

Процедура РассчитатьПремии()
	
	Запрос = Новый Запрос;
	// Берем сумму из регистра накопления "ВыполненныеСотрудникомРаботы"
	// Там уже лежит готовая сумма (Часы * Ставка * Процент)
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	ТЧ.Сотрудник КАК Сотрудник,
	|	ТЧ.ВидРасчета КАК ВидРасчета,
	|	ЕСТЬNULL(ВКМ_ВыполненныеСотрудникомРаботыОбороты.СуммаКОплатеОборот, 0) КАК СуммаПремии
	|ИЗ
	|	Документ.ВКМ_НачисленияЗарплаты.ДополнительныеНачисления КАК ТЧ
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.ВКМ_ВыполненныеСотрудникомРаботы.Обороты(&НачалоПериода, &КонецПериода,,) КАК
	|			ВКМ_ВыполненныеСотрудникомРаботыОбороты
	|		ПО ТЧ.Сотрудник = ВКМ_ВыполненныеСотрудникомРаботыОбороты.Сотрудник
	|ГДЕ
	|	ТЧ.Ссылка = &Ссылка
	|	И ТЧ.ВидРасчета = &ВидРасчетаПроцент";
	
	Запрос.УстановитьПараметр("Ссылка", Ссылка);
	Запрос.УстановитьПараметр("НачалоПериода", НачалоМесяца(Дата));
	Запрос.УстановитьПараметр("КонецПериода", КонецМесяца(Дата));
	
	// ВАЖНО: Убедитесь, что в ПланеВидовРасчета ДопНачислений есть "Процент"
	Запрос.УстановитьПараметр("ВидРасчетаПроцент", ПланыВидовРасчета.ВКМ_ДополнительныеНачисления.Процент);
	
	Выборка = Запрос.Выполнить().Выбрать();
	
	Пока Выборка.Следующий() Цикл
		
		Движение = Движения.ВКМ_ДополнительныеНачисления.Добавить();
		
		Движение.ПериодРегистрации = Дата;
		Движение.ВКМ_Сотрудник         = Выборка.Сотрудник;
		Движение.ВидРасчета        = Выборка.ВидРасчета;
		Движение.ВКМ_Результат     = Выборка.СуммаПремии; // Проверьте имя ресурса в регистре ДопНачислений!
		
	КонецЦикла;
	
	Движения.ВКМ_ДополнительныеНачисления.Записать();
	
КонецПроцедуры

Процедура РассчитатьНДФЛ()
	
	// Сначала записываем удержания, потом очищаем, чтобы пересчитать
	Движения.ВКМ_Удержания.Записывать = Истина;
	Движения.ВКМ_Удержания.Очистить();
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	Начисления.Сотрудник КАК Сотрудник,
	|	СУММА(Начисления.Результат) КАК РезультатBase
	|ИЗ
	|	(ВЫБРАТЬ
	|		Осн.Сотрудник КАК Сотрудник,
	|		Осн.ВКМ_Результат КАК Результат
	|	ИЗ
	|		РегистрРасчета.ВКМ_ОсновныеНачисления КАК Осн
	|	ГДЕ
	|		Осн.Регистратор = &Ссылка
	|
	|	ОБЪЕДИНИТЬ ВСЕ
	|
	|	ВЫБРАТЬ
	|		Доп.Сотрудник,
	|		Доп.ВКМ_Результат
	|	ИЗ
	|		РегистрРасчета.ВКМ_ДополнительныеНачисления КАК Доп
	|	ГДЕ
	|		Доп.Регистратор = &Ссылка) КАК Начисления
	|СГРУППИРОВАТЬ ПО
	|	Начисления.Сотрудник";
	
	Запрос.УстановитьПараметр("Ссылка", Ссылка);
	
	Выборка = Запрос.Выполнить().Выбрать();
	
	Пока Выборка.Следующий() Цикл
		Движение = Движения.ВКМ_Удержания.Добавить();
		Движение.ПериодРегистрации = Дата;
		Движение.ВКМ_Сотрудник = Выборка.Сотрудник;
		Движение.ВидРасчета = ПланыВидовРасчета.ВКМ_Удержания.НДФЛ;
		
		// Округляем налог до целого
		Движение.ВКМ_Результат = Окр(Выборка.РезультатBase * 0.13, 0);
		
	КонецЦикла;
	
	Движения.ВКМ_Удержания.Записать();
	
КонецПроцедуры

Процедура ЗаполнитьВзаиморасчеты()
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	ВКМ_ОсновныеНачисления.Сотрудник КАК Сотрудник,
	|	СУММА(ВКМ_ОсновныеНачисления.ВКМ_Результат) КАК Сумма
	|ПОМЕСТИТЬ ВТ_Начисления
	|ИЗ
	|	РегистрРасчета.ВКМ_ОсновныеНачисления КАК ВКМ_ОсновныеНачисления
	|ГДЕ
	|	ВКМ_ОсновныеНачисления.Регистратор = &Ссылка
	|СГРУППИРОВАТЬ ПО
	|	ВКМ_ОсновныеНачисления.Сотрудник
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	ВКМ_ДополнительныеНачисления.Сотрудник,
	|	СУММА(ВКМ_ДополнительныеНачисления.ВКМ_Результат)
	|ИЗ
	|	РегистрРасчета.ВКМ_ДополнительныеНачисления КАК ВКМ_ДополнительныеНачисления
	|ГДЕ
	|	ВКМ_ДополнительныеНачисления.Регистратор = &Ссылка
	|СГРУППИРОВАТЬ ПО
	|	ВКМ_ДополнительныеНачисления.Сотрудник
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	ВКМ_Удержания.Сотрудник,
	|	-СУММА(ВКМ_Удержания.ВКМ_Результат)
	|ИЗ
	|	РегистрРасчета.ВКМ_Удержания КАК ВКМ_Удержания
	|ГДЕ
	|	ВКМ_Удержания.Регистратор = &Ссылка
	|СГРУППИРОВАТЬ ПО
	|	ВКМ_Удержания.Сотрудник
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ВТ_Начисления.Сотрудник КАК Сотрудник,
	|	СУММА(ВТ_Начисления.Сумма) КАК Сумма
	|ИЗ
	|	ВТ_Начисления КАК ВТ_Начисления
	|СГРУППИРОВАТЬ ПО
	|	ВТ_Начисления.Сотрудник";
	
	Запрос.УстановитьПараметр("Ссылка", Ссылка);
	
	Выборка = Запрос.Выполнить().Выбрать();
	
	Пока Выборка.Следующий() Цикл
		Движение = Движения.ВКМ_ВзаиморасчетыССотрудниками.Добавить();
		Движение.ВидДвижения = ВидДвиженияНакопления.Приход;
		Движение.Период = Дата;
		Движение.ВКМ_Сотрудник = Выборка.Сотрудник;
		Движение.ВКМ_Сумма = Выборка.Сумма;
	КонецЦикла;
	
КонецПроцедуры

Процедура РассчитатьОтпускные()
	
	Запрос = Новый Запрос;
	// Собираем базу за 12 месяцев. 
	// База = Сумма (Оклад + Премии) / Отработано Дней (из регистра Оклада)
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	ТЧ.НомерСтроки КАК НомерСтроки,
	|	ТЧ.Сотрудник КАК Сотрудник,
	|	ТЧ.ДатаНачала КАК ДатаНачала,
	|	ТЧ.ДатаОкончания КАК ДатаОкончания,
	|	ДОБАВИТЬКДАТЕ(НАЧАЛОПЕРИОДА(ТЧ.ДатаНачала, МЕСЯЦ), МЕСЯЦ, -12) КАК НачалоБазовогоПериода,
	|	ДОБАВИТЬКДАТЕ(НАЧАЛОПЕРИОДА(ТЧ.ДатаНачала, МЕСЯЦ), СЕКУНДА, -1) КАК КонецБазовогоПериода
	|ПОМЕСТИТЬ ВТ_ДанныеДокумента
	|ИЗ
	|	Документ.ВКМ_НачисленияЗарплаты.Начисления КАК ТЧ
	|ГДЕ
	|	ТЧ.Ссылка = &Ссылка
	|	И ТЧ.ВидРасчета = &ВидРасчетаОтпуск
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ВТ.НомерСтроки КАК НомерСтроки,
	|	ВТ.ДатаНачала КАК ДатаНачала,
	|	ВТ.ДатаОкончания КАК ДатаОкончания,
	|	ЕСТЬNULL(БазаОклад.ВКМ_Результат, 0) КАК РезультатОклад,
	|	ЕСТЬNULL(БазаОклад.ВКМ_ОтработаноДней, 0) КАК ОтработаноДней,
	|	ЕСТЬNULL(БазаПремия.ВКМ_Результат, 0) КАК РезультатПремия
	|ИЗ
	|	ВТ_ДанныеДокумента КАК ВТ
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрРасчета.ВКМ_ОсновныеНачисления КАК БазаОклад
	|		ПО ВТ.Сотрудник = БазаОклад.Сотрудник
	|		И БазаОклад.ПериодРегистрации МЕЖДУ ВТ.НачалоБазовогоПериода И ВТ.КонецБазовогоПериода
	|		И БазаОклад.ВидРасчета = &ВидОклад
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрРасчета.ВКМ_ДополнительныеНачисления КАК БазаПремия
	|		ПО ВТ.Сотрудник = БазаПремия.Сотрудник
	|		И БазаПремия.ПериодРегистрации МЕЖДУ ВТ.НачалоБазовогоПериода И ВТ.КонецБазовогоПериода
	|		И БазаПремия.ВидРасчета = &ВидПремия";
	
	Запрос.УстановитьПараметр("Ссылка", Ссылка);
	Запрос.УстановитьПараметр("ВидРасчетаОтпуск", ПланыВидовРасчета.ВКМ_ОсновныеНачисления.Отпуск);
	Запрос.УстановитьПараметр("ВидОклад", ПланыВидовРасчета.ВКМ_ОсновныеНачисления.Оклад);
	// Исправил: Используем "Процент", который мы начисляли специалистам, или "Премию", если есть.
	Запрос.УстановитьПараметр("ВидПремия", ПланыВидовРасчета.ВКМ_ДополнительныеНачисления.Процент);
	
	Выборка = Запрос.Выполнить().Выбрать();
	
	ТаблицаДанных = Новый ТаблицаЗначений;
	ТаблицаДанных.Колонки.Добавить("НомерСтроки");
	ТаблицаДанных.Колонки.Добавить("ДатаНачала");
	ТаблицаДанных.Колонки.Добавить("ДатаОкончания");
	ТаблицаДанных.Колонки.Добавить("СуммаБазы");
	ТаблицаДанных.Колонки.Добавить("ОтработаноДней"); 
	
	Пока Выборка.Следующий() Цикл
		НоваяСтрока = ТаблицаДанных.Добавить();
		НоваяСтрока.НомерСтроки = Выборка.НомерСтроки;
		НоваяСтрока.ДатаНачала = Выборка.ДатаНачала;
		НоваяСтрока.ДатаОкончания = Выборка.ДатаОкончания;
		НоваяСтрока.СуммаБазы = Выборка.РезультатОклад + Выборка.РезультатПремия;
		НоваяСтрока.ОтработаноДней = Выборка.ОтработаноДней;
	КонецЦикла;
	
	// Сворачиваем данные (т.к. у одного сотрудника много записей за 12 месяцев)
	ТаблицаДанных.Свернуть("НомерСтроки, ДатаНачала, ДатаОкончания", "СуммаБазы, ОтработаноДней");
	
	Для Каждого СтрокаИтог Из ТаблицаДанных Цикл
		
		ДнейОтпуска = (СтрокаИтог.ДатаОкончания - СтрокаИтог.ДатаНачала) / 86400 + 1;
		
		СреднийЗаработок = 0;
		// Защита от деления на 0
		Если СтрокаИтог.ОтработаноДней > 0 Тогда
			СреднийЗаработок = СтрокаИтог.СуммаБазы / СтрокаИтог.ОтработаноДней; 
		КонецЕсли;
		
		СуммаНачисления = СреднийЗаработок * ДнейОтпуска;
		
		Движение = Движения.ВКМ_ОсновныеНачисления[СтрокаИтог.НомерСтроки - 1];
		Движение.ВКМ_Результат = СуммаНачисления;
		
		// Отпуск не создает "отработанные дни", он их тратит, поле можно оставить пустым или 0
		Движение.ВКМ_ОтработаноДней = 0; 
	КонецЦикла;
	
КонецПроцедуры

#КонецОбласти