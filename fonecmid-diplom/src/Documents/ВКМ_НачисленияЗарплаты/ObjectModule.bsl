#Область ОбработкаПроведения

Процедура ОбработкаПроведения(Отказ, Режим)
	
	// -------------------------------------------------------------------------
	// ЭТАП 1: Подготовка и запись "грязных" данных
	// Мы переносим строки из ТЧ в Регистр, чтобы 1С сама посчитала "Время" (Факт)
	// -------------------------------------------------------------------------
	
	// Очищаем набор записей
	Движения.ВКМ_ОсновныеНачисления.Записывать = Истина;
	Движения.ВКМ_ОсновныеНачисления.Очистить();
	
	Для Каждого ТекСтрока Из Начисления Цикл
		
		// Обрабатываем только "Оклад" и "Отпуск" (Основные начисления)
		// Проверка: Принадлежит ли ВидРасчета этому ПлануВидовРасчета?
		Если ТекСтрока.ВидРасчета = Неопределено Тогда 
			Продолжить; 
		КонецЕсли; 
		
		Движение = Движения.ВКМ_ОсновныеНачисления.Добавить();
		
		// Заполняем свойства
		Движение.Сотрудник       = ТекСтрока.Сотрудник;
		Движение.ПериодДействияНачало = ТекСтрока.ДатаНачала;
		Движение.ПериодДействияКонец  = ТекСтрока.ДатаОкончания;
		Движение.ПериодРегистрации    = Дата; // Дата самого документа
		Движение.ВидРасчета      = ТекСтрока.ВидРасчета;
		ПараметрыЗаписи = Новый Структура("График", ТекСтрока.ГрафикРаботы);
        // Копируем значение из структуры в движение
        ЗаполнитьЗначенияСвойств(Движение, ПараметрыЗаписи);
		
		// Важно: Связь с графиком для расчета
		// Мы используем регистр сведений, но значение графика берем из справочника в ТЧ
		// Примечание: В регистре расчета мы настроили связь "График" -> "ГрафикРаботы"
		
	КонецЦикла;
	
	// ФИЗИЧЕСКАЯ ЗАПИСЬ В БАЗУ
	// В этот момент 1С смотрит в График, смотрит на Вытеснение (Отпуска)
	// и рассчитывает ресурс "ОтработаноДней" (ВКМ_ОтработаноДней)
	Движения.ВКМ_ОсновныеНачисления.Записать();
	
	
	// -------------------------------------------------------------------------
	// ЭТАП 2: Расчет денег (Запрос к базе)
	// Теперь читаем то, что записали, и соединяем с Окладами и Графиком (Нормой)
	// -------------------------------------------------------------------------
	
Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	ВКМ_ОсновныеНачисленияДанныеГрафика.НомерСтроки КАК НомерСтроки,
		|	ВКМ_ОсновныеНачисленияДанныеГрафика.ВидРасчета КАК ВидРасчета,
		|	ВКМ_ОсновныеНачисленияДанныеГрафика.Сотрудник КАК Сотрудник,
		|	ЕСТЬNULL(ВКМ_ОсновныеНачисленияДанныеГрафика.ЗначениеФактическийПериодДействия, 0) КАК ОтработаноДней,
		|	ЕСТЬNULL(ВКМ_ОсновныеНачисленияДанныеГрафика.ЗначениеПериодДействия, 0) КАК НормаДней,
		|	ЕСТЬNULL(ВКМ_УсловияОплатыСотрудниковСрезПоследних.Оклад, 0) КАК Оклад
		|ИЗ
		|	РегистрРасчета.ВКМ_ОсновныеНачисления.ДанныеГрафика(
		|			Регистратор = &Регистратор
		|				И ВидРасчета = &ВидРасчетаОклад) КАК ВКМ_ОсновныеНачисленияДанныеГрафика
		|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ВКМ_УсловияОплатыСотрудников.СрезПоследних(
		|				&ПериодРегистрации,
		|				Сотрудник В
		|					(ВЫБРАТЬ
		|						Т.Сотрудник
		|					ИЗ
		|						РегистрРасчета.ВКМ_ОсновныеНачисления.ДанныеГрафика(
		|								Регистратор = &Регистратор
		|									И ВидРасчета = &ВидРасчетаОклад) КАК Т)) КАК ВКМ_УсловияОплатыСотрудниковСрезПоследних
		|		ПО ВКМ_ОсновныеНачисленияДанныеГрафика.Сотрудник = ВКМ_УсловияОплатыСотрудниковСрезПоследних.Сотрудник";
	
	Запрос.УстановитьПараметр("Регистратор", Ссылка);
	Запрос.УстановитьПараметр("ВидРасчетаОклад", ПланыВидовРасчета.ВКМ_ОсновныеНачисления.Оклад);
	Запрос.УстановитьПараметр("ПериодРегистрации", Дата);
	
	Результат = Запрос.Выполнить();
	Выборка = Результат.Выбрать();
	
	// -------------------------------------------------------------------------
	// ЭТАП 3: Финальный расчет и перезапись
	// -------------------------------------------------------------------------
	
	Пока Выборка.Следующий() Цикл
		
		СтрокаДвижения = Движения.ВКМ_ОсновныеНачисления.Получить(Выборка.НомерСтроки - 1);
		
		// Защита от деления на 0 и пустоты
		Оклад = ?(Выборка.Оклад = NULL, 0, Выборка.Оклад);
		Отработано = ?(Выборка.ОтработаноДней = NULL, 0, Выборка.ОтработаноДней);
		Норма = ?(Выборка.НормаДней = NULL, 0, Выборка.НормаДней);
		
		Если Норма = 0 Тогда
			СтрокаДвижения.ВКМ_Результат = 0;
		Иначе
			СтрокаДвижения.ВКМ_Результат = Оклад * (Отработано / Норма);
		КонецЕсли;
		
		// Сохраняем "Факт" в ресурс
		СтрокаДвижения.ВКМ_ОтработаноДней = Отработано;
		
	КонецЦикла;
	
	// Финальная запись с деньгами
	Движения.ВКМ_ОсновныеНачисления.Записать();
	
// -------------------------------------------------------------------------
// ЭТАП 4: Расчет ОТПУСКНЫХ (Работа с Базой)
// -------------------------------------------------------------------------

// 1. Настраиваем параметры
МассивВидовРасчета = Новый Массив;
МассивВидовРасчета.Добавить(ПланыВидовРасчета.ВКМ_ОсновныеНачисления.Отпуск);

Запрос = Новый Запрос;
Запрос.Текст = 
    "ВЫБРАТЬ
    |    База.НомерСтроки КАК НомерСтроки,
    |    ЕСТЬNULL(База.ВКМ_РезультатБаза, 0) КАК РезультатБаза,
    |    ЕСТЬNULL(База.ВКМ_ОтработаноДнейБаза, 0) КАК ОтработаноДнейБаза,
    |    ЕСТЬNULL(ДанныеГрафика.ЗначениеФактическийПериодДействия, 0) КАК ДнейОтпуска
    |ИЗ
    |    РегистрРасчета.ВКМ_ОсновныеНачисления.БазаВКМ_ОсновныеНачисления(
    |            Регистратор = &РегистраторБаза
    |                И ВидРасчета В (&МассивВидовРасчета)) КАК База
    |        ЛЕВОЕ СОЕДИНЕНИЕ РегистрРасчета.ВКМ_ОсновныеНачисления.ДанныеГрафика КАК ДанныеГрафика
    |        ПО База.НомерСтроки = ДанныеГрафика.НомерСтроки
    |            И База.Регистратор = ДанныеГрафика.Регистратор
    |            И База.ВидРасчета = ДанныеГрафика.ВидРасчета
    |ГДЕ
    |    ДанныеГрафика.Регистратор = &РегистраторДанныеГрафика
    |        И ДанныеГрафика.ВидРасчета В (&МассивВидовРасчета)";

// Параметры
Запрос.УстановитьПараметр("МассивВидовРасчета", МассивВидовРасчета);
Запрос.УстановитьПараметр("РегистраторБаза", Ссылка);
Запрос.УстановитьПараметр("РегистраторДанныеГрафика", Ссылка);

Результат = Запрос.Выполнить();
Выборка = Результат.Выбрать();

Пока Выборка.Следующий() Цикл
    
    СтрокаДвижения = Движения.ВКМ_ОсновныеНачисления.Получить(Выборка.НомерСтроки - 1);
    
    СуммаБазы   = Выборка.РезультатБаза;
    ДниБазы     = Выборка.ОтработаноДнейБаза;
    ДнейОтпуска = Выборка.ДнейОтпуска;
    
    Если ДниБазы = 0 Тогда
        СтрокаДвижения.ВКМ_Результат = 0;
    Иначе
        СтрокаДвижения.ВКМ_Результат = (СуммаБазы / ДниБазы) * ДнейОтпуска;
    КонецЕсли;
    
КонецЦикла;

// Финальная запись
Движения.ВКМ_ОсновныеНачисления.Записать();
	
КонецПроцедуры

#КонецОбласти