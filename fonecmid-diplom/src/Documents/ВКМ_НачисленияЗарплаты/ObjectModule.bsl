#Область ОбработкаПроведения

Процедура ОбработкаПроведения(Отказ, Режим)
	
	// 1. Инициализация набора записей
	Движения.ВКМ_ОсновныеНачисления.Записывать = Истина;
	Движения.ВКМ_ОсновныеНачисления.Очистить();
	
	// 2. Формирование движений (с учетом истории окладов!)
	СформироватьДвиженияПоОкладам();
	
	// 3. Добавление остальных начислений (отпуск и т.д., где не нужна история оклада)
	СформироватьДвиженияПоДругимНачислениям();
	
	// 4. Обработка Сторно (вытеснение)
	СформироватьСторноЗаписи();
	
	// 5. Первая запись (чтобы платформа увидела периоды действия и построила график)
	Движения.ВКМ_ОсновныеНачисления.Записать();
	
	// 6. Расчетные процедуры
	РассчитатьОклад();
	РассчитатьОтпускные();
	
	// 7. Финальная запись с результатами расчетов
	Движения.ВКМ_ОсновныеНачисления.Записать();
	
КонецПроцедуры

#КонецОбласти

#Область СлужебныеПроцедуры

// Самая сложная процедура: разбивает период начисления, если менялся оклад
Процедура СформироватьДвиженияПоОкладам()
	
	// А. Определяем границы периода данных в документе
	МинимальнаяДатаНачала = Неопределено;
	МаксимальнаяДатаОкончания = Неопределено;
	
	ЕстьОклад = Ложь;
	Для Каждого Строка Из Начисления Цикл
		Если Строка.ВидРасчета = ПланыВидовРасчета.ВКМ_ОсновныеНачисления.Оклад Тогда
			ЕстьОклад = Истина;
			Если МинимальнаяДатаНачала = Неопределено Или Строка.ДатаНачала < МинимальнаяДатаНачала Тогда
				МинимальнаяДатаНачала = Строка.ДатаНачала;
			КонецЕсли;
			Если МаксимальнаяДатаОкончания = Неопределено Или Строка.ДатаОкончания > МаксимальнаяДатаОкончания Тогда
				МаксимальнаяДатаОкончания = Строка.ДатаОкончания;
			КонецЕсли;
		КонецЕсли;
	КонецЦикла;
	
	Если Не ЕстьОклад Тогда Возврат; КонецЕсли;

	// Б. Строим таблицу интервалов действия окладов (из Эталона №1)
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	ТЧ.Сотрудник КАК Сотрудник,
	|	ТЧ.ВидРасчета КАК ВидРасчета,
	|	ТЧ.ДатаНачала КАК ДатаНачала,
	|	ТЧ.ДатаОкончания КАК ДатаОкончания,
	|	ТЧ.ГрафикРаботы КАК ГрафикРаботы
	|ПОМЕСТИТЬ ВТ_ТЧ
	|ИЗ
	|	Документ.НачислениеЗарплаты.Начисления КАК ТЧ
	|ГДЕ
	|	ТЧ.Ссылка = &Ссылка
	|	И ТЧ.ВидРасчета = &ВидРасчетаОклад
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	СрезПоследних.Сотрудник,
	|	СрезПоследних.Период,
	|	СрезПоследних.Оклад
	|ПОМЕСТИТЬ ВТ_История
	|ИЗ
	|	РегистрСведений.ВКМ_УсловияОплатыСотрудников.СрезПоследних(&МинимальнаяДатаНачала, Сотрудник В (ВЫБРАТЬ Т.Сотрудник ИЗ ВТ_ТЧ КАК Т)) КАК СрезПоследних
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	История.Сотрудник,
	|	История.Период,
	|	История.Оклад
	|ИЗ
	|	РегистрСведений.ВКМ_УсловияОплатыСотрудников КАК История
	|ГДЕ
	|	История.Период > &МинимальнаяДатаНачала
	|	И История.Период <= &МаксимальнаяДатаОкончания
	|	И История.Сотрудник В (ВЫБРАТЬ Т.Сотрудник ИЗ ВТ_ТЧ КАК Т)
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	История.Сотрудник,
	|	История.Период КАК ДатаНачала,
	|	ЕСТЬNULL(ДОБАВИТЬКДАТЕ(МИНИМУМ(ИсторияСлед.Период), СЕКУНДА, -1), ДАТАВРЕМЯ(3999, 12, 31)) КАК ДатаОкончания,
	|	История.Оклад
	|ПОМЕСТИТЬ ВТ_Интервалы
	|ИЗ
	|	ВТ_История КАК История
	|		ЛЕВОЕ СОЕДИНЕНИЕ ВТ_История КАК ИсторияСлед
	|		ПО История.Сотрудник = ИсторияСлед.Сотрудник
	|			И История.Период < ИсторияСлед.Период
	|
	|СГРУППИРОВАТЬ ПО
	|	История.Сотрудник,
	|	История.Период,
	|	История.Оклад
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ВТ_ТЧ.Сотрудник,
	|	ВТ_ТЧ.ВидРасчета,
	|	ВТ_ТЧ.ГрафикРаботы,
	|	ВЫБОР КОГДА ВТ_ТЧ.ДатаНачала > ВТ_Интервалы.ДатаНачала ТОГДА ВТ_ТЧ.ДатаНачала ИНАЧЕ ВТ_Интервалы.ДатаНачала КОНЕЦ КАК ПериодДействияНачало,
	|	ВЫБОР КОГДА ВТ_ТЧ.ДатаОкончания < ВТ_Интервалы.ДатаОкончания ТОГДА ВТ_ТЧ.ДатаОкончания ИНАЧЕ ВТ_Интервалы.ДатаОкончания КОНЕЦ КАК ПериодДействияКонец,
	|	ВТ_Интервалы.Оклад КАК Показатель
	|ИЗ
	|	ВТ_ТЧ КАК ВТ_ТЧ
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТ_Интервалы КАК ВТ_Интервалы
	|		ПО ВТ_ТЧ.Сотрудник = ВТ_Интервалы.Сотрудник
	|			И ВТ_ТЧ.ДатаНачала <= ВТ_Интервалы.ДатаОкончания
	|			И ВТ_ТЧ.ДатаОкончания >= ВТ_Интервалы.ДатаНачала";
	
	Запрос.УстановитьПараметр("Ссылка", Ссылка);
	Запрос.УстановитьПараметр("ВидРасчетаОклад", ПланыВидовРасчета.ВКМ_ОсновныеНачисления.Оклад);
	Запрос.УстановитьПараметр("МинимальнаяДатаНачала", МинимальнаяДатаНачала);
	Запрос.УстановитьПараметр("МаксимальнаяДатаОкончания", МаксимальнаяДатаОкончания);
	
	Выборка = Запрос.Выполнить().Выбрать();
	
	Пока Выборка.Следующий() Цикл
		Движение = Движения.ВКМ_ОсновныеНачисления.Добавить();
		ЗаполнитьЗначенияСвойств(Движение, Выборка);
		Движение.ПериодРегистрации = Дата;
		// Оклад (Показатель) уже заполнен запросом
	КонецЦикла;

КонецПроцедуры

Процедура СформироватьДвиженияПоДругимНачислениям()
	
	Для Каждого Строка Из Начисления Цикл
		Если Строка.ВидРасчета = ПланыВидовРасчета.ВКМ_ОсновныеНачисления.Оклад Тогда
			Продолжить; // Оклад уже обработан
		КонецЕсли;
		
		Движение = Движения.ВКМ_ОсновныеНачисления.Добавить();
		Движение.ПериодРегистрации    = Дата;
		Движение.ПериодДействияНачало = Строка.ДатаНачала;
		Движение.ПериодДействияКонец  = Строка.ДатаОкончания;
		Движение.Сотрудник            = Строка.Сотрудник;
		Движение.ВидРасчета           = Строка.ВидРасчета;
		Движение.ГрафикРаботы         = Строка.ГрафикРаботы;
	КонецЦикла;
	
КонецПроцедуры

Процедура СформироватьСторноЗаписи()
	
	// Получаем записи, которые вытесняются нашими новыми движениями
	СторноЗаписи = Движения.ВКМ_ОсновныеНачисления.ПолучитьДополнение();
	
	Для Каждого СтрокаСторно Из СторноЗаписи Цикл
		Движение = Движения.ВКМ_ОсновныеНачисления.Добавить();
		
		// Копируем все поля
		ЗаполнитьЗначенияСвойств(Движение, СтрокаСторно);
		
		Движение.ПериодРегистрации = Дата; // Сторнируем в текущем периоде
		Движение.ПериодДействияНачало = СтрокаСторно.ПериодДействияНачалоСторно;
		Движение.ПериодДействияКонец = СтрокаСторно.ПериодДействияКонецСторно;
		
		// Инвертируем ресурсы
		Движение.Сторно = Истина;
		Движение.ВКМ_Результат = -СтрокаСторно.ВКМ_Результат;
		Движение.ВКМ_ОтработаноДней = -СтрокаСторно.ВКМ_ОтработаноДней;
	КонецЦикла;
	
КонецПроцедуры

Процедура РассчитатьОклад()
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	ДанныеГрафика.НомерСтроки КАК НомерСтроки,
	|	ЕСТЬNULL(ДанныеГрафика.ЗначениеФактическийПериодДействия, 0) КАК Отработано,
	|	ЕСТЬNULL(ДанныеГрафика.ЗначениеПериодДействия, 0) КАК Норма
	|ИЗ
	|	РегистрРасчета.ВКМ_ОсновныеНачисления.ДанныеГрафика(
	|			Регистратор = &Ссылка
	|			И ВидРасчета = &ВидРасчетаОклад) КАК ДанныеГрафика";
	
	Запрос.УстановитьПараметр("Ссылка", Ссылка);
	Запрос.УстановитьПараметр("ВидРасчетаОклад", ПланыВидовРасчета.ВКМ_ОсновныеНачисления.Оклад);
	
	Выборка = Запрос.Выполнить().Выбрать();
	
	Пока Выборка.Следующий() Цикл
		
		Движение = Движения.ВКМ_ОсновныеНачисления[Выборка.НомерСтроки - 1];
		
		// Показатель (размер оклада) у нас уже есть в движении, мы его записали на этапе 1
		Оклад = ?(Движение.Показатель = 0, 0, Движение.Показатель); 
		
		Если Выборка.Норма = 0 Тогда
			Движение.ВКМ_Результат = 0;
		Иначе
			Движение.ВКМ_Результат = Оклад * Выборка.Отработано / Выборка.Норма;
		КонецЕсли;
		
		Движение.ВКМ_ОтработаноДней = Выборка.Отработано;
		
		// Обработка Сторно при перерасчете
		Если Движение.Сторно Тогда
			Движение.ВКМ_Результат = -Движение.ВКМ_Результат;
			Движение.ВКМ_ОтработаноДней = -Движение.ВКМ_ОтработаноДней;
		КонецЕсли;
		
	КонецЦикла;
	
КонецПроцедуры

Процедура РассчитатьОтпускные()
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	ДанныеГрафика.НомерСтроки КАК НомерСтроки,
	|	ЕСТЬNULL(ДанныеГрафика.ЗначениеФактическийПериодДействия, 0) КАК ДнейОтпуска,
	|	ЕСТЬNULL(База.ВКМ_РезультатБаза, 0) КАК СуммаБазы,
	|	ЕСТЬNULL(База.ВКМ_ОтработаноДнейБаза, 0) КАК ДниБазы
	|ИЗ
	|	РегистрРасчета.ВКМ_ОсновныеНачисления.ДанныеГрафика(
	|			Регистратор = &Ссылка
	|			И ВидРасчета = &ВидРасчетаОтпуск) КАК ДанныеГрафика
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрРасчета.ВКМ_ОсновныеНачисления.БазаВКМ_ОсновныеНачисления(
	|				&Измерения,
	|				&Измерения,
	|				,
	|				Регистратор = &Ссылка
	|				И ВидРасчета = &ВидРасчетаОтпуск) КАК База
	|		ПО ДанныеГрафика.НомерСтроки = База.НомерСтроки";
	
	Запрос.УстановитьПараметр("Ссылка", Ссылка);
	Запрос.УстановитьПараметр("ВидРасчетаОтпуск", ПланыВидовРасчета.ВКМ_ОсновныеНачисления.Отпуск);
	
	// Важно! Указываем измерения, чтобы база не схлопнулась, если сотрудник встречается дважды
	Измерения = Новый Массив;
	Измерения.Добавить("Сотрудник");
	Запрос.УстановитьПараметр("Измерения", Измерения);
	
	Выборка = Запрос.Выполнить().Выбрать();
	
	Пока Выборка.Следующий() Цикл
		
		Движение = Движения.ВКМ_ОсновныеНачисления[Выборка.НомерСтроки - 1];
		
		СреднийЗаработок = 0;
		Если Выборка.ДниБазы > 0 Тогда
			СреднийЗаработок = Выборка.СуммаБазы / Выборка.ДниБазы;
		КонецЕсли;
		
		Движение.ВКМ_Результат = СреднийЗаработок * Выборка.ДнейОтпуска;
		Движение.ВКМ_ОтработаноДней = Выборка.ДнейОтпуска; // Или 0, зависит от учетной политики по отпускам
		
		// Сторно для отпуска обычно не актуально в контексте перерасчета, но можно добавить проверку
		Если Движение.Сторно Тогда
			Движение.ВКМ_Результат = -Движение.ВКМ_Результат;
		КонецЕсли;
		
	КонецЦикла;

КонецПроцедуры

#КонецОбласти