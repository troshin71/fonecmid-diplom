#Область ОбработкаПроведения

Процедура ОбработкаПроведения(Отказ, Режим)
	
	// -------------------------------------------------------------------------
	// ЭТАП 1: Подготовка и запись "грязных" данных
	// Мы переносим строки из ТЧ в Регистр, чтобы 1С сама посчитала "Время" (Факт)
	// -------------------------------------------------------------------------
	
	// Очищаем набор записей
	Движения.ВКМ_ОсновныеНачисления.Записывать = Истина;
	Движения.ВКМ_ОсновныеНачисления.Очистить();
	
	Для Каждого ТекСтрока Из Начисления Цикл
		
		// Обрабатываем только "Оклад" и "Отпуск" (Основные начисления)
		// Проверка: Принадлежит ли ВидРасчета этому ПлануВидовРасчета?
		Если ТекСтрока.ВидРасчета = Неопределено Тогда 
			Продолжить; 
		КонецЕсли; 
		
		Движение = Движения.ВКМ_ОсновныеНачисления.Добавить();
		
		// Заполняем свойства
		Движение.Сотрудник       = ТекСтрока.Сотрудник;
		Движение.ПериодДействияНачало = ТекСтрока.ДатаНачала;
		Движение.ПериодДействияКонец  = ТекСтрока.ДатаОкончания;
		Движение.ПериодРегистрации    = Дата; // Дата самого документа
		Движение.ВидРасчета      = ТекСтрока.ВидРасчета;
		Движение.График    = ТекСтрока.ГрафикРаботы;
		
		// Важно: Связь с графиком для расчета
		// Мы используем регистр сведений, но значение графика берем из справочника в ТЧ
		// Примечание: В регистре расчета мы настроили связь "График" -> "ГрафикРаботы"
		
	КонецЦикла;
	
	// ФИЗИЧЕСКАЯ ЗАПИСЬ В БАЗУ
	// В этот момент 1С смотрит в График, смотрит на Вытеснение (Отпуска)
	// и рассчитывает ресурс "ОтработаноДней" (ВКМ_ОтработаноДней)
	Движения.ВКМ_ОсновныеНачисления.Записать();
	
	
	// -------------------------------------------------------------------------
	// ЭТАП 2: Расчет денег (Запрос к базе)
	// Теперь читаем то, что записали, и соединяем с Окладами и Графиком (Нормой)
	// -------------------------------------------------------------------------
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	ВКМ_ОсновныеНачисленияДанныеГрафика.НомерСтроки КАК НомерСтроки,
		|	ВКМ_ОсновныеНачисленияДанныеГрафика.ВидРасчета КАК ВидРасчета,
		|	ВКМ_ОсновныеНачисленияДанныеГрафика.Сотрудник КАК Сотрудник,
		|	ВКМ_ОсновныеНачисленияДанныеГрафика.ЗначениеФактическийПериодДействия КАК ОтработаноДней,
		|	ВКМ_ОсновныеНачисленияДанныеГрафика.ЗначениеПериодДействия КАК НормаДней,
		|	ЕСТЬNULL(ВКМ_УсловияОплатыСотрудниковСрезПоследних.Оклад, 0) КАК Оклад
		|ИЗ
		|	РегистрРасчета.ВКМ_ОсновныеНачисления.ДанныеГрафика(
		|			Регистратор = &Регистратор
		|				И ВидРасчета = &ВидРасчетаОклад) КАК ВКМ_ОсновныеНачисленияДанныеГрафика
		|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ВКМ_УсловияОплатыСотрудников.СрезПоследних(
		|				&ПериодРегистрации,
		|				Сотрудник В
		|					(ВЫБРАТЬ
		|						Т.Сотрудник
		|					ИЗ
		|						РегистрРасчета.ВКМ_ОсновныеНачисления.ДанныеГрафика(
		|								Регистратор = &Регистратор
		|									И ВидРасчета = &ВидРасчетаОклад) КАК Т)) КАК ВКМ_УсловияОплатыСотрудниковСрезПоследних
		|		ПО ВКМ_ОсновныеНачисленияДанныеГрафика.Сотрудник = ВКМ_УсловияОплатыСотрудниковСрезПоследних.Сотрудник";
	
	Запрос.УстановитьПараметр("Регистратор", Ссылка);
	Запрос.УстановитьПараметр("ВидРасчетаОклад", ПланыВидовРасчета.ВКМ_ОсновныеНачисления.Оклад);
	Запрос.УстановитьПараметр("ПериодРегистрации", Дата);
	
	Результат = Запрос.Выполнить();
	Выборка = Результат.Выбрать();
	
	// -------------------------------------------------------------------------
	// ЭТАП 3: Финальный расчет и перезапись
	// -------------------------------------------------------------------------
	
	Пока Выборка.Следующий() Цикл
		
		// Получаем нужную строку из набора записей по НомеруСтроки
		// (Так мы меняем именно ту запись, которую создали выше)
		СтрокаДвижения = Движения.ВКМ_ОсновныеНачисления.Получить(Выборка.НомерСтроки - 1);
		
		// Логика расчета
		// Результат = Оклад * (Факт / Норма)
		
		Если Выборка.НормаДней = 0 Тогда
			СтрокаДвижения.ВКМ_Результат = 0;
		Иначе
			СтрокаДвижения.ВКМ_Результат = Выборка.Оклад * (Выборка.ОтработаноДней / Выборка.НормаДней);
		КонецЕсли;
		
		// Сохраняем "Факт" в ресурс (чтобы видеть в отчете)
		СтрокаДвижения.ВКМ_ОтработаноДней = Выборка.ОтработаноДней;
		
	КонецЦикла;
	
	// Финальная запись с деньгами
	Движения.ВКМ_ОсновныеНачисления.Записать();
	
КонецПроцедуры

#КонецОбласти