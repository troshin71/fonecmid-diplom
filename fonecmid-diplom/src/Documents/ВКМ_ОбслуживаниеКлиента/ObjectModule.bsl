#Область ОбработкаПроведения

Процедура ОбработкаПроведения(Отказ, Режим)
	
	// 1. Инициализация движений
	Движения.ВКМ_ВыполненныеКлиентуРаботы.Записывать = Истина;
	Движения.ВКМ_ВыполненныеСотрудникомРаботы.Записывать = Истина;
	
	Движения.ВКМ_ВыполненныеКлиентуРаботы.Очистить();
	Движения.ВКМ_ВыполненныеСотрудникомРаботы.Очистить();
	
	// 2. Проверка заполнения Договора (если нужно, раскомментируйте или вставьте свои проверки)
	Если Не ЗначениеЗаполнено(ВКМ_Договор) Тогда
		Сообщение = Новый СообщениеПользователю;
		Сообщение.Текст = "Не заполнен договор!";
		Сообщение.Поле = "ВКМ_Договор";
		Сообщение.Сообщить();
		Отказ = Истина;
		Возврат;
	КонецЕсли;
	
	// ПРОВЕРКИ ПО ЗАДАНИЮ
	
	// 1. Проверка вида договора
	Если ВКМ_Договор.ВидДоговора <> Перечисления.ВидыДоговоровКонтрагентов.ВКМ_АбонентскоеОбслуживание Тогда
		Сообщение = Новый СообщениеПользователю;
		Сообщение.Текст = "Договор не является абонентским!";
		Сообщение.Поле = "ВКМ_Договор";
		Сообщение.Сообщить();
		Отказ = Истина;
		Возврат;
	КонецЕсли;
	
	// 2. Проверка срока действия договора
	// Важно: проверяем, заполнены ли даты в договоре, чтобы избежать ошибок сравнения
	Если ЗначениеЗаполнено(ВКМ_Договор.ВКМ_ДатаНачала) 
		И Дата < ВКМ_Договор.ВКМ_ДатаНачала Тогда
		
		Сообщение = Новый СообщениеПользователю;
		Сообщение.Текст = "Договор еще не вступил в действие!";
		Сообщение.Поле = "ВКМ_Договор";
		Сообщение.Сообщить();
		Отказ = Истина;
		Возврат;
	КонецЕсли;
	
	Если ЗначениеЗаполнено(ВКМ_Договор.ВКМ_ДатаОкончания) 
		И Дата > ВКМ_Договор.ВКМ_ДатаОкончания Тогда
		
		Сообщение = Новый СообщениеПользователю;
		Сообщение.Текст = "Срок действия договора истек!";
		Сообщение.Поле = "ВКМ_Договор";
		Сообщение.Сообщить();
		Отказ = Истина;
		Возврат;
	КонецЕсли;


	
	// 3. Получение процента оплаты сотрудника
	
	Отбор = Новый Структура("Сотрудник", ВКМ_Специалист);
	УсловияОплаты = РегистрыСведений.ВКМ_УсловияОплатыСотрудников.ПолучитьПоследнее(Дата, Отбор);
	
	Процент = 0;
	Если УсловияОплаты.ПроцентОтРабот = Неопределено Тогда
		Сообщение = Новый СообщениеПользователю;
		Сообщение.Текст = "Не установлен процент оплаты для специалиста " + Строка(ВКМ_Специалист);
		Сообщение.Сообщить();
		Отказ = Истина;
		Возврат;
	Иначе
		Процент = УсловияОплаты.ПроцентОтРабот;
	КонецЕсли;
	
	// 4. Подготовка данных для расчета
	СтоимостьЧаса = 0;
	
	Если ЗначениеЗаполнено(ВКМ_Договор) Тогда
		СтоимостьЧаса = ВКМ_Договор.ВКМ_СтоимостьЧасаРаботы;
	КонецЕсли;
	
	СуммаВсегоПоДокументу = 0;
	ЧасыВсегоПоДокументу = 0;
	
	// 5. Цикл по работам (Заполняем регистр "ВыполненныеКлиентуРаботы")
	Для Каждого ТекСтрока Из ВКМ_ВыполненныеРаботы Цикл
		
		Движение = Движения.ВКМ_ВыполненныеКлиентуРаботы.Добавить();
		Движение.Период = Дата;
		Движение.ВКМ_Клиент = ВКМ_Клиент;
		Движение.ВКМ_Договор = ВКМ_Договор;
		Движение.ВКМ_КоличествоЧасов = ТекСтрока.ВКМ_ЧасыКОплатеКлиенту;
		Движение.ВКМ_СуммаКОплате = ТекСтрока.ВКМ_ЧасыКОплатеКлиенту * СтоимостьЧаса;

		ЧасыВсегоПоДокументу = ЧасыВсегоПоДокументу + ТекСтрока.ВКМ_ЧасыКОплатеКлиенту;
		СуммаВсегоПоДокументу = СуммаВсегоПоДокументу + (ТекСтрока.ВКМ_ЧасыКОплатеКлиенту * СтоимостьЧаса);
		
	КонецЦикла;
	
	// 6. Запись в регистр зарплаты (ВыполненныеСотрудникомРаботы)

	ДвижениеЗП = Движения.ВКМ_ВыполненныеСотрудникомРаботы.Добавить();
	ДвижениеЗП.Период = Дата;
	ДвижениеЗП.Сотрудник = ВКМ_Специалист;
	ДвижениеЗП.ЧасовКОплате = ЧасыВсегоПоДокументу;
	
	// Расчет суммы сотруднику 
	ДвижениеЗП.СуммаКОплате = СуммаВсегоПоДокументу * Процент / 100;
	
КонецПроцедуры

#КонецОбласти