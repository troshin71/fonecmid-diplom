#Область ОбработкаПроведения

Процедура ОбработкаПроведения(Отказ, Режим)
	Движения.ВКМ_ВыполненныеКлиентуРаботы.Записывать = Истина;
	Движения.ВКМ_ВыполненныеСотрудникомРаботы.Записывать = Истина;
	
	Движения.ВКМ_ВыполненныеКлиентуРаботы.Очистить();
	Движения.ВКМ_ВыполненныеСотрудникомРаботы.Очистить();
	
	// 1. Проверки (Договор и сроки) - оставляем как было...
	// ... (тут твой код проверок договора) ...

	// 2. Получение Процента (СТРОГО ПО ТЗ)
	Отбор = Новый Структура("Сотрудник", ВКМ_Специалист);
	УсловияОплаты = РегистрыСведений.ВКМ_УсловияОплатыСотрудников.ПолучитьПоследнее(Дата, Отбор);
	
	Процент = 0;
	Если УсловияОплаты.ПроцентОтРабот = Неопределено Тогда
		// ТЗ: "Если ... не установлен процент ... документ не должен проводится"
		Сообщение = Новый СообщениеПользователю;
		Сообщение.Текст = "Не установлен процент оплаты для специалиста " + ВКМ_Специалист;
		Сообщение.Сообщить();
		Отказ = Истина;
		Возврат;
	Иначе
		Процент = УсловияОплаты.ПроцентОтРабот;
	КонецЕсли;
	
	// 3. Расчеты
	СтоимостьЧаса = ВКМ_Договор.ВКМ_СтоимостьЧасаРаботы;
	
	СуммаВсегоПоДокументу = 0;
	ЧасыВсегоПоДокументу = 0;
	
	Для Каждого ТекСтрока Из ВКМ_ВыполненныеРаботы Цикл
		
		// Движения по клиенту
		Движение = Движения.ВКМ_ВыполненныеКлиентуРаботы.Добавить();
		Движение.Период = Дата;
		Движение.ВКМ_Клиент = ВКМ_Клиент;
		Движение.ВКМ_Договор = ВКМ_Договор;
		Движение.ВКМ_КоличествоЧасов = ТекСтрока.ВКМ_ЧасыКОплатеКлиенту;
		Движение.ВКМ_СуммаКОплате = ТекСтрока.ВКМ_ЧасыКОплатеКлиенту * СтоимостьЧаса;
		
		ЧасыВсегоПоДокументу = ЧасыВсегоПоДокументу + ТекСтрока.ВКМ_ЧасыКОплатеКлиенту;
		СуммаВсегоПоДокументу = СуммаВсегоПоДокументу + (ТекСтрока.ВКМ_ЧасыКОплатеКлиенту * СтоимостьЧаса);
		
	КонецЦикла;
	
	// Движения по сотруднику
	ДвижениеЗП = Движения.ВКМ_ВыполненныеСотрудникомРаботы.Добавить();
	ДвижениеЗП.Период = Дата;
	ДвижениеЗП.Сотрудник = ВКМ_Специалист;
	ДвижениеЗП.ЧасовКОплате = ЧасыВсегоПоДокументу;
	
	// ТЗ: СуммаКОплате = Часов * Ставка * Процент / 100
	// (СуммаВсегоПоДокументу уже содержит Часов * Ставка)
	ДвижениеЗП.СуммаКОплате = СуммаВсегоПоДокументу * Процент / 100;
	
КонецПроцедуры

#КонецОбласти