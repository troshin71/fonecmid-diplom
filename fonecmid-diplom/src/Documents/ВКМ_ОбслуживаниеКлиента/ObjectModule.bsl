#Область ОбработкаПроведения

Процедура ОбработкаПроведения(Отказ, Режим)
	
	// 1. Инициализация движений
	Движения.ВКМ_ВыполненныеКлиентуРаботы.Записывать = Истина;
	Движения.ВКМ_ВыполненныеСотрудникомРаботы.Записывать = Истина; // <--- Добавили новый регистр
	
	
	// Проверка вида договора
	Если ВКМ_Договор.ВидДоговора <> Перечисления.ВидыДоговоровКонтрагентов.ВКМ_АбонентскоеОбслуживание Тогда
		Сообщение = Новый СообщениеПользователю;
		Сообщение.Текст = "Выбранный договор не является договором абонентского обслуживания!";
		Сообщение.Поле = "ВКМ_Договор";
		Сообщение.УстановитьДанные(ЭтотОбъект);
		Сообщение.Сообщить();
		// Отказ = Истина; // По желанию
	КонецЕсли;
	
	// Проверка сроков договора
	Если ЗначениеЗаполнено(ВКМ_Договор.ВКМ_ДатаНачала) И Дата < ВКМ_Договор.ВКМ_ДатаНачала Тогда
		Сообщение = Новый СообщениеПользователю;
		Сообщение.Текст = "Дата документа меньше даты начала действия договора!";
		Сообщение.Поле = "Дата";
		Сообщение.УстановитьДанные(ЭтотОбъект);
		Сообщение.Сообщить();
		Отказ = Истина;
	КонецЕсли;

	Если ЗначениеЗаполнено(ВКМ_Договор.ВКМ_ДатаОкончания) И Дата > ВКМ_Договор.ВКМ_ДатаОкончания Тогда
		Сообщение = Новый СообщениеПользователю;
		Сообщение.Текст = "Срок действия договора истек!";
		Сообщение.Поле = "Дата";
		Сообщение.УстановитьДанные(ЭтотОбъект);
		Сообщение.Сообщить();
		Отказ = Истина;
	КонецЕсли;
	
	// --- ВКМ_Начало: Новая проверка условий оплаты специалиста ---
	
	// Получаем условия оплаты сотрудника на дату документа
	Отбор = Новый Структура("Сотрудник", ВКМ_Специалист);
	УсловияОплаты = РегистрыСведений.ВКМ_УсловияОплатыСотрудников.ПолучитьПоследнее(Дата, Отбор);
	
	// Проверяем, задан ли процент (если записи нет, будет Неопределено)
	Если УсловияОплаты.ПроцентОтРабот = Неопределено Тогда 
		Отказ = Истина;
		Сообщение = Новый СообщениеПользователю;
		Сообщение.Текст = "Не установлен процент оплаты для специалиста: " + ВКМ_Специалист;
		Сообщение.Сообщить();
	КонецЕсли;
	
	// --- ВКМ_Конец ---

	Если Отказ Тогда
		Возврат;
	КонецЕсли;
	
	
	// -----------------------------------------------------------------------
	// БЛОК 2: Движения
	// -----------------------------------------------------------------------
	
	СтоимостьЧаса = ВКМ_Договор.ВКМ_СтоимостьЧасаРаботы;
	
	// Переменные для расчета итогов по документу (для зарплаты)
	СуммаВсегоПоДокументу = 0;
	ЧасыВсегоПоДокументу  = 0;
	
	Для Каждого ТекСтрока Из ВКМ_ВыполненныеРаботы Цикл
		
		// 2.1. Запись в регистр "ВыполненныеКлиентуРаботы" (Долг клиента)
		Движение = Движения.ВКМ_ВыполненныеКлиентуРаботы.Добавить();
		Движение.Период = Дата;
		Движение.ВКМ_Клиент = ВКМ_Клиент;
		Движение.ВКМ_Договор = ВКМ_Договор;
		Движение.ВКМ_КоличествоЧасов = ТекСтрока.ВКМ_ЧасыКОплатеКлиенту;
		
		СуммаСтроки = ТекСтрока.ВКМ_ЧасыКОплатеКлиенту * СтоимостьЧаса;
		Движение.ВКМ_СуммаКОплате = СуммаСтроки;
		
		// Копим итоги для зарплаты специалиста
		ЧасыВсегоПоДокументу  = ЧасыВсегоПоДокументу + ТекСтрока.ВКМ_ЧасыКОплатеКлиенту;
		СуммаВсегоПоДокументу = СуммаВсегоПоДокументу + СуммаСтроки;
		
	КонецЦикла;
	
	// 2.2. Запись в регистр "ВыполненныеСотрудникомРаботы" (Зарплата специалиста)
	// Делаем одну запись на весь документ
	
	ДвижениеЗП = Движения.ВКМ_ВыполненныеСотрудникомРаботы.Добавить();
	ДвижениеЗП.Период = Дата;
	ДвижениеЗП.Сотрудник = ВКМ_Специалист;
	ДвижениеЗП.ЧасовКОплате = ЧасыВсегоПоДокументу;
	
	// Расчет суммы к начислению: (СуммаКлиента * Процент) / 100
	ДвижениеЗП.СуммаКОплате = СуммаВсегоПоДокументу * УсловияОплаты.ПроцентОтРабот / 100;
	
КонецПроцедуры

#КонецОбласти