#Область ОбработкаПроведения

Процедура ОбработкаПроведения(Отказ, Режим)
	
	// 1. Инициализация движений
	Движения.ВКМ_ВыполненныеКлиентуРаботы.Записывать = Истина;
	Движения.ВКМ_ВыполненныеСотрудникомРаботы.Записывать = Истина; 
	
	// Проверка вида договора
	// Используем перечисление из метаданных
	Если ВКМ_Договор.ВидДоговора <> Перечисления.ВидыДоговоровКонтрагентов.ВКМ_АбонентскоеОбслуживание Тогда
		Сообщение = Новый СообщениеПользователю;
		Сообщение.Текст = "Выбранный договор не является договором абонентского обслуживания!";
		Сообщение.Поле = "ВКМ_Договор";
		Сообщение.УстановитьДанные(ЭтотОбъект);
		Сообщение.Сообщить();
		// Отказ = Истина; // Можно оставить предупреждением или запретить
	КонецЕсли;
	
	// Проверка сроков договора
	Если ЗначениеЗаполнено(ВКМ_Договор.ВКМ_ДатаНачала) И Дата < ВКМ_Договор.ВКМ_ДатаНачала Тогда
		Сообщение = Новый СообщениеПользователю;
		Сообщение.Текст = "Дата документа меньше даты начала действия договора!";
		Сообщение.Сообщить();
		Отказ = Истина;
	КонецЕсли;

	Если ЗначениеЗаполнено(ВКМ_Договор.ВКМ_ДатаОкончания) И Дата > ВКМ_Договор.ВКМ_ДатаОкончания Тогда
		Сообщение = Новый СообщениеПользователю;
		Сообщение.Текст = "Срок действия договора истек!";
		Сообщение.Сообщить();
		Отказ = Истина;
	КонецЕсли;
	
	// ВАЖНО: Блок проверки процента удален. 
	// Мы не должны блокировать работу менеджера, если кадровик еще не завел процент сотруднику.
	// Ошибка вылезет при начислении зарплаты, и там её исправлять логичнее.

	Если Отказ Тогда Возврат; КонецЕсли;
	
	// -----------------------------------------------------------------------
	// БЛОК 2: Движения
	// -----------------------------------------------------------------------
	
	// Получаем ставку из договора
	СтоимостьЧаса = ВКМ_Договор.ВКМ_СтоимостьЧасаРаботы;
	
	СуммаВсегоПоДокументу = 0;
	ЧасыВсегоПоДокументу  = 0;
	
	Для Каждого ТекСтрока Из ВКМ_ВыполненныеРаботы Цикл
		
		// 2.1. Запись в регистр взаиморасчетов с клиентом
		Движение = Движения.ВКМ_ВыполненныеКлиентуРаботы.Добавить();
		Движение.Период = Дата;
		Движение.ВКМ_Клиент = ВКМ_Клиент;
		Движение.ВКМ_Договор = ВКМ_Договор;
		Движение.ВКМ_КоличествоЧасов = ТекСтрока.ВКМ_ЧасыКОплатеКлиенту;
		
		СуммаСтроки = ТекСтрока.ВКМ_ЧасыКОплатеКлиенту * СтоимостьЧаса;
		Движение.ВКМ_СуммаКОплате = СуммаСтроки;
		
		// Копим итоги для записи в регистр сотрудника
		ЧасыВсегоПоДокументу  = ЧасыВсегоПоДокументу + ТекСтрока.ВКМ_ЧасыКОплатеКлиенту;
		СуммаВсегоПоДокументу = СуммаВсегоПоДокументу + СуммаСтроки;
		
	КонецЦикла;
	
	// 2.2. Запись в регистр "ВыполненныеСотрудникомРаботы"
	// Мы записываем ПОЛНУЮ сумму работ. Процент применится в документе НачисленияЗарплаты.
	
	ДвижениеЗП = Движения.ВКМ_ВыполненныеСотрудникомРаботы.Добавить();
	ДвижениеЗП.Период = Дата;
	ДвижениеЗП.Сотрудник = ВКМ_Специалист; //
	ДвижениеЗП.ЧасовКОплате = ЧасыВсегоПоДокументу;
	ДвижениеЗП.СуммаКОплате = СуммаВсегоПоДокументу; // <--- ИСПРАВЛЕНО ЗДЕСЬ
	
КонецПроцедуры

#КонецОбласти