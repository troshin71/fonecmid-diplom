#Область ОбработкаПроведения

Процедура ОбработкаПроведения(Отказ, Режим)
	
	// --- 1. ПРОВЕРКИ (согласно заданию) ---
	
	// 1.1. Проверка заполненности договора
	Если Не ЗначениеЗаполнено(ВКМ_Договор) Тогда
		Сообщение = Новый СообщениеПользователю;
		Сообщение.Текст = "Не заполнен договор!";
		Сообщение.Поле = "ВКМ_Договор";
		Сообщение.УстановитьДанные(ЭтотОбъект);
		Сообщение.Сообщить();
		Отказ = Истина;
		Возврат;
	КонецЕсли;

	// 1.2. Проверка вида договора (Абонентское обслуживание)
	Если ВКМ_Договор.ВидДоговора <> Перечисления.ВидыДоговоровКонтрагентов.ВКМ_АбонентскоеОбслуживание Тогда
		Сообщение = Новый СообщениеПользователю;
		Сообщение.Текст = "Выбранный договор не является договором абонентского обслуживания!";
		Сообщение.Поле = "ВКМ_Договор";
		Сообщение.УстановитьДанные(ЭтотОбъект);
		Сообщение.Сообщить();
		Отказ = Истина;
		Возврат;
	КонецЕсли;
	
	// 1.3. Проверка срока действия договора
	// Проверяем, попадает ли Дата документа в интервал [ДатаНачала ... ДатаОкончания]
	Если ЗначениеЗаполнено(ВКМ_Договор.ВКМ_ДатаНачала) И Дата < ВКМ_Договор.ВКМ_ДатаНачала Тогда
		Сообщение = Новый СообщениеПользователю;
		Сообщение.Текст = "Договор еще не вступил в силу (Дата начала: " + Формат(ВКМ_Договор.ВКМ_ДатаНачала, "ДЛФ=D") + ")";
		Сообщение.Поле = "ВКМ_Договор";
		Сообщение.УстановитьДанные(ЭтотОбъект);
		Сообщение.Сообщить();
		Отказ = Истина;
		Возврат;
	КонецЕсли;
	
	Если ЗначениеЗаполнено(ВКМ_Договор.ВКМ_ДатаОкончания) И Дата > ВКМ_Договор.ВКМ_ДатаОкончания Тогда
		Сообщение = Новый СообщениеПользователю;
		Сообщение.Текст = "Срок действия договора истек (Дата окончания: " + Формат(ВКМ_Договор.ВКМ_ДатаОкончания, "ДЛФ=D") + ")";
		Сообщение.Поле = "ВКМ_Договор";
		Сообщение.УстановитьДанные(ЭтотОбъект);
		Сообщение.Сообщить();
		Отказ = Истина;
		Возврат;
	КонецЕсли;

	// --- 2. ПОДГОТОВКА ДАННЫХ ---

	// Инициализация наборов записей
	Движения.ВКМ_ВыполненныеКлиентуРаботы.Записывать = Истина;
	Движения.ВКМ_ВыполненныеСотрудникомРаботы.Записывать = Истина;
	
	Движения.ВКМ_ВыполненныеКлиентуРаботы.Очистить();
	Движения.ВКМ_ВыполненныеСотрудникомРаботы.Очистить();
	
	// Получаем процент оплаты сотрудника
	Отбор = Новый Структура("ВКМ_Сотрудник", ВКМ_Специалист);
	УсловияОплаты = РегистрыСведений.ВКМ_УсловияОплатыСотрудников.ПолучитьПоследнее(Дата, Отбор);
	
	Процент = 0;
	Если УсловияОплаты.ВКМ_ПроцентОтРабот = Неопределено Тогда
		// Это не критичная ошибка для проведения, но можно предупредить
		// Или сделать отказ, если без процента нельзя работать.
		// Допустим, считаем по 0 ставке, если нет данных.
	Иначе
		Процент = УсловияОплаты.ВКМ_ПроцентОтРабот;
	КонецЕсли;
	
	СтоимостьЧаса = ВКМ_Договор.ВКМ_СтоимостьЧасаРаботы;
	
	СуммаВсегоПоДокументу = 0;
	ЧасыВсегоПоДокументу = 0;
	
	// --- 3. ЗАПОЛНЕНИЕ РЕГИСТРОВ ---
	
	// Заполняем регистр "ВыполненныеКлиентуРаботы"
	Для Каждого ТекСтрока Из ВКМ_ВыполненныеРаботы Цикл
		
		Движение = Движения.ВКМ_ВыполненныеКлиентуРаботы.Добавить();
		Движение.Период = Дата;
		Движение.ВКМ_Клиент = ВКМ_Клиент;
		Движение.ВКМ_Договор = ВКМ_Договор;
		
		// ВАЖНО: Измерения "ВКМ_Номенклатура" здесь нет, так как мы его удалили по рекомендации.
		// Если вы его не удалили из регистра, раскомментируйте строку ниже:
		// Движение.ВКМ_Номенклатура = ТекСтрока.ВКМ_Номенклатура; 
		
		Движение.ВКМ_КоличествоЧасов = ТекСтрока.ВКМ_ЧасыКОплатеКлиенту;
		Движение.ВКМ_СуммаКОплате = ТекСтрока.ВКМ_ЧасыКОплатеКлиенту * СтоимостьЧаса;

		ЧасыВсегоПоДокументу = ЧасыВсегоПоДокументу + ТекСтрока.ВКМ_ЧасыКОплатеКлиенту;
		СуммаВсегоПоДокументу = СуммаВсегоПоДокументу + (ТекСтрока.ВКМ_ЧасыКОплатеКлиенту * СтоимостьЧаса);
		
	КонецЦикла;
	
	// Заполняем регистр "ВыполненныеСотрудникомРаботы" (для зарплаты)
	Если ЧасыВсегоПоДокументу > 0 Тогда
		ДвижениеЗП = Движения.ВКМ_ВыполненныеСотрудникомРаботы.Добавить();
		ДвижениеЗП.Период = Дата;
		ДвижениеЗП.ВКМ_Сотрудник = ВКМ_Специалист;
		ДвижениеЗП.ЧасовКОплате = ЧасыВсегоПоДокументу;
		ДвижениеЗП.ВКМ_СуммаКОплате = СуммаВсегоПоДокументу * Процент / 100;
	КонецЕсли;
	
КонецПроцедуры

#КонецОбласти