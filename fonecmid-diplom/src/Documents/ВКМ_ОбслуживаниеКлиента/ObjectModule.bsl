#Область ОбработкаПроведения

// ВКМ_Начало
Процедура ОбработкаПроведения(Отказ, Режим)
	
	// 1. Инициализация движений
	Движения.ВКМ_ВыполненныеКлиентуРаботы.Записывать = Истина;
	
	// 2. Проверки по заданию
	// Проверка 1: Договор должен быть "Абонентское обслуживание"
	Если ВКМ_Договор.ВидДоговора <> Перечисления.ВидыДоговоровКонтрагентов.ВКМ_АбонентскоеОбслуживание Тогда
		// Задание не требует строгого Отказа, но логически это ошибка.
		// Можно выдать сообщение, но разрешить проведение (или запретить, поставив Отказ = Истина)
		Сообщение = Новый СообщениеПользователю;
		Сообщение.Текст = "Выбранный договор не является договором абонентского обслуживания!";
		Сообщение.Поле = "ВКМ_Договор";
		Сообщение.УстановитьДанные(ЭтотОбъект);
		Сообщение.Сообщить();
		// Отказ = Истина; // Раскомментируй, если нужно жестко блокировать
	КонецЕсли;
	
	// Проверка 2: Дата документа внутри периода действия договора
	// Если ДатаНачала заполнена и документ раньше нее
	Если ЗначениеЗаполнено(ВКМ_Договор.ВКМ_ДатаНачала) И Дата < ВКМ_Договор.ВКМ_ДатаНачала Тогда
		Сообщение = Новый СообщениеПользователю;
		Сообщение.Текст = "Дата документа меньше даты начала действия договора!";
		Сообщение.Поле = "Дата";
		Сообщение.УстановитьДанные(ЭтотОбъект);
		Сообщение.Сообщить();
		Отказ = Истина;
	КонецЕсли;

	// Если ДатаОкончания заполнена и документ позже нее
	Если ЗначениеЗаполнено(ВКМ_Договор.ВКМ_ДатаОкончания) И Дата > ВКМ_Договор.ВКМ_ДатаОкончания Тогда
		Сообщение = Новый СообщениеПользователю;
		Сообщение.Текст = "Срок действия договора истек!";
		Сообщение.Поле = "Дата";
		Сообщение.УстановитьДанные(ЭтотОбъект);
		Сообщение.Сообщить();
		Отказ = Истина;
	КонецЕсли;

	Если Отказ Тогда
		Возврат;
	КонецЕсли;
	
	// 3. Формирование движений
	// Нам нужна стоимость часа из договора
	СтоимостьЧаса = ВКМ_Договор.ВКМ_СтоимостьЧасаРаботы;
	
	Для Каждого ТекСтрока Из ВКМ_ВыполненныеРаботы Цикл
		
		Движение = Движения.ВКМ_ВыполненныеКлиентуРаботы.Добавить();
		
		Движение.Период = Дата;
		Движение.ВКМ_Клиент = ВКМ_Клиент;
		Движение.ВКМ_Договор = ВКМ_Договор;
		
		Движение.ВКМ_КоличествоЧасов = ТекСтрока.ВКМ_ЧасыКОплатеКлиенту;
		
		// Расчет суммы: Часы * Ставка
		Движение.ВКМ_СуммаКОплате = ТекСтрока.ВКМ_ЧасыКОплатеКлиенту * СтоимостьЧаса;
		
	КонецЦикла;
	
КонецПроцедуры
// ВКМ_Конец

Процедура ПриОпределенииСправочниковХраненияФайлов(ТипВладелецФайла, ИменаСправочников) Экспорт
	
	// ВКМ_Начало
	// Связываем наш документ с нашим справочником файлов
	Если ТипВладелецФайла = Тип("ДокументСсылка.ВКМ_ОбслуживаниеКлиента") Тогда
		ИменаСправочников["ВКМ_ОбслуживаниеКлиентаПрисоединенныеФайлы"] = Истина;
	КонецЕсли;
	// ВКМ_Конец
	
КонецПроцедуры

#КонецОбласти