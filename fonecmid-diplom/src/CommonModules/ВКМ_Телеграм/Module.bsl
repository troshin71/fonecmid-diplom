#Область ПрограммныйИнтерфейс

// Функция отправляет сообщение в Телеграм
// Возвращает Истина, если отправка успешна (код 200), иначе Ложь
Функция ОтправитьСообщение(ТекстСообщения) Экспорт
	
	Токен = Константы.ВКМ_ТокенУправленияТелеграмБотом.Получить();
	ЧатID = Константы.ВКМ_ИдентификаторГруппыДляОповещения.Получить();
	
	// Если константы пустые — нет смысла отправлять
	Если ПустаяСтрока(Токен) ИЛИ ПустаяСтрока(ЧатID) Тогда
		Возврат Ложь;
	КонецЕсли;
	
	Сервер = "api.telegram.org";
	Ресурс = "bot" + Токен + "/sendMessage";
	
	// ВАЖНО: Кодируем строку, чтобы пробелы, кириллица и спецсимволы корректно передались в URL
	ТекстДляUrl = КодироватьСтроку(ТекстСообщения, СпособКодированияСтроки.URLВКодировкеURL);
	
	СтрокаСоединения = "?chat_id=" + ЧатID + "&text=" + ТекстДляUrl;
	
	Попытка
		HTTPСоединение = Новый HTTPСоединение(Сервер, 443, , , , , Новый ЗащищенноеСоединениеOpenSSL);
		HTTPЗапрос = Новый HTTPЗапрос(Ресурс + СтрокаСоединения);
		
		Ответ = HTTPСоединение.Получить(HTTPЗапрос);
		
		// Проверяем статус ответа (200 OK)
		Если Ответ.КодСостояния = 200 Тогда
			Возврат Истина;
		Иначе
			// Логируем ошибку, если Телеграм вернул не 200 (например, 400 или 401)
			ТекстОшибки = "Ошибка Telegram. Код: " + Ответ.КодСостояния + ". Тело: " + Ответ.ПолучитьТелоКакСтроку();
			ЗаписьЖурналаРегистрации("ВКМ_Телеграм", УровеньЖурналаРегистрации.Ошибка, , , ТекстОшибки);
			Возврат Ложь;
		КонецЕсли;
		
	Исключение
		// Логируем ошибку соединения (например, нет интернета)
		ЗаписьЖурналаРегистрации("ВКМ_Телеграм", УровеньЖурналаРегистрации.Ошибка, , , 
			"Ошибка соединения: " + ОписаниеОшибки());
		Возврат Ложь;
	КонецПопытки;

КонецФункции

// Процедура для регламентного задания
// Читает очередь сообщений из справочника и отправляет их в Телеграм
Процедура ОтправитьУведомленияПоРасписанию() Экспорт
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	Уведомления.Ссылка КАК Ссылка,
		|	Уведомления.ВКМ_ТекстСообщения КАК ТекстСообщения
		|ИЗ
		|	Справочник.ВКМ_УведомленияТелеграмБоту КАК Уведомления";
	
	Выборка = Запрос.Выполнить().Выбрать();
	
	Пока Выборка.Следующий() Цикл
		
		// Пытаемся отправить сообщение
		Успешно = ОтправитьСообщение(Выборка.ТекстСообщения);
		
		// Если отправилось успешно — удаляем из базы.
		// Если ошибка — оставляем, попробуем в следующий раз (или можно ввести счетчик попыток)
		Если Успешно Тогда
			Попытка
				УведомлениеОбъект = Выборка.Ссылка.ПолучитьОбъект();
				УведомлениеОбъект.Удалить();
			Исключение
				ЗаписьЖурналаРегистрации("ВКМ_Телеграм", УровеньЖурналаРегистрации.Ошибка, , , 
					"Не удалось удалить уведомление: " + ОписаниеОшибки());
			КонецПопытки;
		КонецЕсли;
		
	КонецЦикла;
	
КонецПроцедуры

#КонецОбласти