#Область ПрограммныйИнтерфейс

// Функция отправляет сообщение в Телеграм
// Параметры:
//  ТекстСообщения - Строка - текст для отправки
Процедура ОтправитьСообщение(ТекстСообщения) Экспорт
	
	Токен = Константы.ВКМ_ТокенУправленияТелеграмБотом.Получить();
	ЧатID = Константы.ВКМ_ИдентификаторГруппыДляОповещения.Получить();
	
	Если ПустаяСтрока(Токен) ИЛИ ПустаяСтрока(ЧатID) Тогда
		Возврат;
	КонецЕсли;
	
	// API Telegram: https://api.telegram.org/bot<token>/sendMessage
	Сервер = "api.telegram.org";
	Ресурс = "bot" + Токен + "/sendMessage";
	
	// Параметры запроса
	СтрокаСоединения = "?chat_id=" + ЧатID + "&text=" + ТекстСообщения;
	
	Попытка
		HTTPСоединение = Новый HTTPСоединение(Сервер, 443, , , , , Новый ЗащищенноеСоединениеOpenSSL);
		HTTPЗапрос = Новый HTTPЗапрос(Ресурс + СтрокаСоединения);
		
		Ответ = HTTPСоединение.Получить(HTTPЗапрос);
		
		// Для отладки можно проверять КодСостояния (должен быть 200)
		// Если Ответ.КодСостояния <> 200 Тогда ... КонецЕсли;
		
	Исключение
		ЗаписьЖурналаРегистрации("ВКМ_Телеграм", УровеньЖурналаРегистрации.Ошибка, , , 
			"Ошибка отправки сообщения: " + ОписаниеОшибки());
	КонецПопытки;

КонецПроцедуры

// Процедура для регламентного задания
// Читает очередь сообщений из справочника и отправляет их в Телеграм
Процедура ОтправитьУведомленияПоРасписанию() Экспорт
	
	// 1. Выбираем все сообщения из нашей очереди (Справочника)
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	Уведомления.Ссылка КАК Ссылка,
		|	Уведомления.ВКМ_ТекстСообщения КАК ТекстСообщения
		|ИЗ
		|	Справочник.ВКМ_УведомленияТелеграмБоту КАК Уведомления";
	
	Выборка = Запрос.Выполнить().Выбрать();
	
	// 2. Проходим по каждому сообщению
	Пока Выборка.Следующий() Цикл
		
		// Отправляем сообщение, используя нашу готовую процедуру
		ОтправитьСообщение(Выборка.ТекстСообщения);
		
		// 3. После отправки удаляем запись из справочника, чтобы не отправить дважды
		Попытка
			УведомлениеОбъект = Выборка.Ссылка.ПолучитьОбъект();
			УведомлениеОбъект.Удалить();
		Исключение
			// Если не удалось удалить (например, заблокировано), пишем в журнал регистрации
			ЗаписьЖурналаРегистрации("ВКМ_Телеграм", УровеньЖурналаРегистрации.Ошибка, , , 
				"Не удалось удалить уведомление: " + ОписаниеОшибки());
		КонецПопытки;
		
	КонецЦикла;
	
КонецПроцедуры

#КонецОбласти